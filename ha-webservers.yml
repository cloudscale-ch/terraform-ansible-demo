- name: Install HA webserver with keepalived
  hosts: keepalived00:keepalived01
  user: root
  tasks:
    - name: Create floating IPv4
      cloudscale_floating_ip:
        ip_version: 4
        server: '{{ cloudscale.uuid }}'
      register: floating_ip_4
      delegate_to: localhost
      run_once: True

    - name: Create floating IPv6
      cloudscale_floating_ip:
        ip_version: 6
        server: '{{ cloudscale.uuid }}'
      register: floating_ip_6
      delegate_to: localhost
      run_once: True

    - name: Install packages
      apt:
        name:
          - curl
          - keepalived
          - nginx

    - name: Remove cloud-init autogenerated network config
      file:
        path: /etc/network/interfaces.d/50-cloud-init.cfg
        state: absent

    - name: Fixup network configuration
      lineinfile:
        path: /etc/network/interfaces
        line: 'source /etc/network/interfaces.d/*.cfg'

    - name: Configure floating IP
      template:
        src: templates/dummy0-floating-ip.cfg.j2
        dest: /etc/network/interfaces.d/dummy0-floating-ip.cfg
        owner: root
        group: root
        mode: '0644'
      notify: Activate floating IP

    - name: Create basic welcome website
      copy:
        dest: /var/www/html/index.html
        content: '<html><body><h1>Welcome to {{ ansible_hostname }}</h1></body></html>'
        owner: root
        group: root
        mode: '0644'

    - name: Install floating IP management script
      template:
        src: templates/master.sh.j2
        dest: /etc/keepalived/master.sh
        owner: root
        group: root
        mode: '0755'

    - name: Configure keepalived
      template:
        src: templates/keepalived.conf.j2
        dest: /etc/keepalived/keepalived.conf
        owner: root
        group: root
        mode: '0644'
      notify: Restart keepalived

  handlers:
    - name: Restart keepalived
      service:
        name: keepalived
        state: restarted

    - name: Activate floating IP
      shell: ifdown dummy0 ; ifup dummy0
